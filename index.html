<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="no">
    <link rel="shortcut icon" href="favicon.ico">
    <title>Зараза</title>
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <div class="warning-overlay" id="warningOverlay">
        <div class="warning-box">
            <div class="warning-title">ПРЕДУПРЕЖДЕНИЕ</div>
            <div class="warning-text">Использование данного инструмента может привести к непредвиденным последствиям. Автор предупреждает о возможных рисках и не несет ответственности за любые полученные результаты.</div>
            <!-- ОТДЕЛЬНЫЕ СТРОКИ ДЛЯ РАЗНОЙ ИНФОРМАЦИИ -->
			<div style="margin-bottom: 20px;"><button id="readParableBtn" class="ui-btn parable-btn">Притча</button></div>
            <div class="warning-info">
                <div class="warning-info-item"><strong>Браузер:</strong> <span id="browserInfo">Загрузка...</span></div>
                <div class="warning-info-item"><strong>Версия от:</strong> <span id="versionInfo">Загрузка...</span></div>
                <div class="warning-info-item"><strong>Сегодня:</strong> <span id="todayInfo">Загрузка...</span></div>
            </div>
            <div class="warning-actions">
                <button id="acceptWarning" class="ui-btn">Согласиться и продолжить</button>
            </div>
        </div>
        
        <!-- Модальное окно притчи (изначально скрыто) -->
        <div class="parable-modal hidden" id="parableModal">
            <div class="parable-modal-header">
                <h2 class="parable-modal-title">Притча о Светоносной деве</h2>
                <button class="ui-btn parable-modal-close" id="closeParableBtn">× Закрыть</button>
            </div>
            <div class="parable-modal-content" id="parableContent">
                <!-- Содержимое будет вставлено из JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Угловые квадраты -->
    <div class="corner-square tl" data-action="toggleUI"></div>
    <div class="corner-square tr" data-action="toggleUI"></div>
    <div class="corner-square bl" data-action="toggleUI"></div>
    <div class="corner-square br" data-action="toggleUI"></div>
    <div class="corner-square tc" data-action="toggleUI"></div>
    <div class="corner-square bc" data-action="toggleUI"></div>
    <div class="corner-square lc" data-action="toggleUI"></div>
    <div class="corner-square rc" data-action="toggleUI"></div>
    <div class="corner-square mt" data-action="toggleUI"></div>
    <div class="corner-square mb" data-action="toggleUI"></div>
    <div class="corner-square ml" data-action="toggleUI"></div>
    <div class="corner-square mr" data-action="toggleUI"></div>
    <div class="corner-square mt2" data-action="toggleUI"></div>
    <div class="corner-square mb2" data-action="toggleUI"></div>
    <div class="corner-square ml2" data-action="toggleUI"></div>
    <div class="corner-square mr2" data-action="toggleUI"></div>
    
    <div class="interface-container">
        <div class="container">

            <div class="panel-section buttons-panel">
                <div class="corner-controls">
                    <button class="ui-btn" data-action="toggleCorners">Угловые</button>
                    <button class="ui-btn" data-action="toggleAxial">Осевые</button>
                    <button class="ui-btn" data-action="toggleVertical">Вертикальные</button>
                    <button class="ui-btn" data-action="toggleSides">Боковые</button>
                    <button class="ui-btn" data-action="toggleMiddle">Средние</button>
                    <button class="ui-btn" data-action="toggleLeft">Левые</button>
                    <button class="ui-btn" data-action="toggleRight">Правые</button>
                    <button class="ui-btn" data-action="toggleTop">Верхние</button>
                    <button class="ui-btn" data-action="toggleBottom">Нижние</button>
                    <button class="ui-btn" data-action="toggleAllSquares">Все</button>
                    <!-- ПЕРЕИМЕНОВАНО: Сброс углов -> Сброс цвета краев -->
                    <button class="ui-btn" data-action="resetCorners">Сброс цвета краев</button>
                </div>
                <div class="transform-row">
                    <button class="ui-btn" data-action="toggleUI">Переключить UI</button>
                    <button class="ui-btn" data-action="toggleSquares">Квадратики</button>
                    <button class="ui-btn" data-action="toggleGrayMode">Серость</button>
                    <button class="ui-btn" data-action="toggleStars">Звездочки</button>
                    <button class="ui-btn" data-action="exportDates">Экспорт дат</button>
                    <button class="ui-btn" data-action="exportWaves">Экспорт колосков</button>
                    <button class="ui-btn" data-action="exportAll">Экспорт всего</button>
                    <button class="ui-btn" data-action="importAll">Импорт</button>
                    <input type="file" id="importAllFile" accept=".json" style="display:none">
                    <button class="ui-btn" data-action="resetAll">Сброс всего</button>
                </div>
            </div>

			<div class="panel-section tabs-section" id="tabs-section">
				<div class="tab-container">
					<!-- Кнопки табов -->
					<div class="tab-buttons">
						<button class="tab-button" data-tab="summary">
							Состояния (рабочая)
						</button>
						<button class="tab-button" data-tab="intersections">
							Пересечения (в разработке)
						</button>
						<button class="tab-button" data-tab="notes">
							Записи (вроде работало)
						</button>
						<button class="tab-button" data-tab="db-import">
							Импорт базы данных (вроде работало)
						</button>
					</div>
					
					<!-- Контент табов -->

					<!-- В блоке #summary-tab -->
					<div class="tab-content" id="summary-tab">
						<div class="panel-section summary-panel" id="summaryPanel">
							<div class="summary-header">
								<h3>Сводная информация о колосках</h3>
							</div>
							
							<div class="summary-controls">
								<div class="summary-select-row">
									<div class="summary-select-group">
										<select class="summary-select" id="summaryGroupSelect">
											<option value="all">Все доступные группы с колосками</option>
											<!-- Опции будут добавлены через JavaScript -->
										</select>
										<select class="summary-select" id="summaryStateSelect">
											<!-- Опции будут добавлены динамически -->
										</select>
										<!-- Кнопки-дублеры -->
										<div class="summary-duplicate-buttons">
											<button class="ui-btn" data-action="today">Сегодня</button>
											<button class="ui-btn" data-action="now">Сейчас</button>
										</div>
									</div>
								</div>
							</div>
							
							<div class="summary-results-container">
								<div class="summary-results" id="summaryResults">
									<!-- Результаты будут заполнены через JavaScript -->
								</div>
							</div>
						</div>
					</div>
					
					<div class="tab-content" id="intersections-tab">
						<div class="panel-section" id="analysis-panel">
							<div class="summary-header">
								<h3>Пересечения колосков за день</h3>
							</div>
							
							<div class="intersection-controls">
								<div class="intersection-form">
									<!-- Верхний ряд: чекбокс и дата -->
									<div class="intersection-form-row">
										<label class="intersection-form-label">
											<input type="checkbox" id="onlyActiveWaves" checked>
											Только активные колоски
										</label>
										
										<div class="intersection-date-group">
											<label class="intersection-form-label">Дата анализа:</label>
											<input type="date" class="intersection-form-input" id="intersectionDate">
										</div>
									</div>
									
									<!-- Второй ряд: кнопки управления -->
									<div class="intersection-form-row">
										<div class="intersection-form-actions">
											<button id="btnCalculateIntersections" class="ui-btn">
												Рассчитать за день
											</button>
											
											<button id="btnUpdateForCurrentDate" class="ui-btn">
												Для текущей даты
											</button>
											
											<button id="btnClearIntersections" class="ui-btn">
												Очистить
											</button>
										</div>
									</div>
								</div>
							</div>
							
							<!-- Статистика -->
							<div class="intersection-stats" id="intersectionStats" style="display:none">
								<!-- Будет заполняться динамически -->
							</div>
							
							<!-- Результаты -->
							<div class="intersection-results-container">
								<div class="intersection-results" id="intersectionResults">
									<div class="list-empty">
										Нет рассчитанных пересечений. Нажмите "Рассчитать за день"
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="tab-content" id="notes-tab">
						<div class="panel-section" id="notes-panel">
							<div class="summary-header">
								<h3>Записи</h3>
							</div>
							<div class="notes-panel-layout">
								<div class="notes-list-container">
									<div class="list-container" id="notesList"></div>
								</div>
								<div class="note-editor-container">
									<div class="notes-section">
										<textarea id="noteInput" placeholder="Введите запись для текущей даты..."></textarea>
										<button id="btnAddNote" class="ui-btn">Добавить запись</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="tab-content" id="db-import-tab">
						<div class="panel-section db-import-section">
							<div class="summary-header">
								<h3>Импорт базы данных</h3>
							</div>
							<div class="db-import-controls">
								<button class="ui-btn" data-action="importDB">Импорт заметок Metaslip</button>
								<input type="file" id="importDBFile" accept=".db" style="display:none">
								<button class="ui-btn" id="btnAnalyzeDB">Анализировать DB</button>
								<button class="ui-btn" id="btnMigrateToNotes">Мигрировать в заметки</button>
								<button class="ui-btn" id="btnClearImportResults">Очистить</button>
							</div>
							<div class="db-import-progress" id="dbImportProgress" style="display:none">
								<div class="db-import-progress-bar" id="dbImportProgressBar" style="width:0%"></div>
							</div>
							<div id="dbImportStatus"></div>
							<textarea class="db-import-textarea" id="dbImportTextarea" placeholder="Результат импорта DB файла появится здесь..."></textarea>
						</div>
					</div>
				</div>
			</div>

            <div class="graph-section">
                <div class="graph-container" id="graphContainer">
                    <div class="graph" id="graphElement">
                        <div class="axis x-axis"></div>
                        <div class="axis y-axis"></div>
                        <div class="center-date-label" id="centerDateLabel"></div>
                        <div class="zoom-overlay" id="zoomOverlay"></div>
                    </div>
                </div>
                <!-- КОНТЕЙНЕР ДЛЯ ВЫНОСОК ПЕРЕМЕЩАЕМ СЮДА (внутри graph-container, но вне graph) -->
                <div class="wave-labels-container" id="waveLabelsContainer">
                    <div class="wave-labels-side wave-labels-left"></div>
                    <div class="wave-labels-side wave-labels-right"></div>
                </div>
            </div>

			<!-- Заменить блок с кнопками навигации в панели buttons-panel -->
			<div class="panel-section buttons-panel">
				<div class="top-controls">
					<button class="ui-btn" data-action="toggleGraph">Переключить визор</button>
					<button class="ui-btn" data-action="toggleWaveLabels">Переключить выноски</button>
					<button class="ui-btn" data-action="toggleGraphGrayMode">Серость визора</button>
					<button class="ui-btn" data-action="toggleBg">Фон</button>
					<button class="ui-btn" data-action="flipH">↔</button>
					<button class="ui-btn" data-action="flipV">↕</button>
					<button class="ui-btn" data-action="rotateL">↶</button>
					<button class="ui-btn" data-action="rotateR">↷</button>
					<button class="ui-btn" data-action="resetTransform">⟲</button>
					<button id="btnPrevDay" class="ui-btn">←</button>
					<button class="current-day ui-btn" id="currentDay">0.00000</button>
					<button id="btnNextDay" class="ui-btn">→</button>
					<button id="btnToday" class="ui-btn" data-action="today">Сегодня</button>
					<button id="btnNow" class="ui-btn" data-action="now">Сейчас</button>
					
					<!-- ИЗМЕНЕНО: Раздельные поля для даты и времени -->
					<div class="date-time-input-group" style="display: flex; gap: 4px; flex: 1; min-width: 0;">
						<input type="date" class="date-input" id="mainDateInputDate" 
							title="Выберите дату" style="flex: 1; min-width: 120px;">
						<input type="time" class="date-input" id="mainDateInputTime" step="1"
							value="00:00:00" title="Введите время (ЧЧ:ММ:СС)">
					</div>
					
					<button id="btnSetDate" class="ui-btn">Перейти</button>
				</div>
			</div>

            <div class="main-controls-panel">
                <div class="control-panel">
                    <div class="panel-section" id="dates-panel">
                        <div class="date-controls-buttons">
                            <input type="date" class="date-input" id="dateInput">
                            <input type="text" class="date-input" id="dateNameInput" placeholder="Название" style="flex:1">
                            <button id="btnAddDate" class="ui-btn">Добавить дату</button>
                        </div>
                        <div class="list-container" id="dateListForDates"></div>
                    </div>
                    <div class="panel-section" id="waves-panel">
                        <!-- УПРОЩЕННАЯ ВЕРСИЯ: только форма добавления волн -->
                        <div class="add-custom-wave-form compact">
                            <div class="add-group-form">
                                <input type="text" class="add-group-input" id="newGroupName" placeholder="Название новой группы" style="flex: 1">
                                <button class="add-group-btn ui-btn" id="btnAddGroup">Добавить группу</button>
                            </div>
                            <div class="wave-inputs-row">
                                <input type="text" class="form-input" id="customWaveName" placeholder="Название колоска" style="flex:2">
                                <input type="number" class="form-input" id="customWavePeriod" placeholder="Период (дней)" min="0.1" step="0.1">
                                <select class="form-input" id="customWaveType">
                                    <option value="solid">Сплошная</option>
                                    <option value="dashed">Пунктирная</option>
                                    <option value="dotted">Точечная</option>
                                    <option value="zigzag">Зигзагообразная</option>
                                    <option value="dash-dot">Штрих-линия</option>
                                    <option value="long-dash">Длинный штрих</option>
                                </select>
                                <input type="color" class="color-input" id="customWaveColor" value="#666666" title="Выберить цвет">
                                <button id="btnAddCustomWave" class="ui-btn">Добавить колосок</button>
                            </div>
                        </div>
                        <div class="waves-list-container">
                            <div class="list-container" id="wavesList"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/ejs@3.1.9/ejs.min.js"></script>

	<script src="modules/timeUtils.js"></script>
	<script src="modules/state.js"></script>
	<script src="modules/dom.js"></script>
	<script src="modules/appCore.js"></script>
	<script src="modules/dataManager.js"></script>
	<script src="modules/intersectionManager.js"></script>
	<script src="modules/uiManager.js"></script>
	<script src="modules/dates.js"></script>
	<script src="modules/waves.js"></script>
	<script src="modules/grid.js"></script>
	<script src="modules/import.js"></script>
	<script src="modules/unifiedListManager.js"></script>
	<script src="modules/eventManager.js"></script>
	<script src="modules/summaryManager.js"></script>
	<script src="modules/init.js"></script>

</body>
</html>